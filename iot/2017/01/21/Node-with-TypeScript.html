<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>
        <meta charset="utf-8">
    <meta name="description" content="We build innovative solutions with Java and JavaScript. To support this mission, we have several Competence Centers. From within those Competence Centers, we provide coaching to the employee and expert advice towards our customer. In order to keep in sync with the latest technologies and the latest trends, we frequently visit conferences around the globe.
">
    <meta name="keywords" content="Ordina,ORAJ,JWorks,Blog,Java,JavaScript,TypeScript,Angular,DevOps">
    <meta name="author" content="Ordina Belgium">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Node with TypeScript - Kevin Van den Abeele">
    <meta name="twitter:description" content="Ordina JWorks Tech Blog">
    <meta name="twitter:image" content="http://ordina-jworks.github.io/img/node-with-typescript/node-ts.jpg"/>

    <!-- Facebook Open Graph -->
    <meta property="og:url" content="http://ordina-jworks.github.io/iot/2017/01/21/Node-with-TypeScript.html"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Node with TypeScript - Kevin Van den Abeele"/>
    <meta property="og:description" content="Ordina JWorks Tech Blog"/>
    <meta property="og:image" content="http://ordina-jworks.github.io/img/node-with-typescript/node-ts.jpg"/>

    
    <title>Node with TypeScript - Kevin Van den Abeele &mdash; Ordina JWorks Tech Blog</title>
    

        <!-- Styles -->
    <!-- Font awesome CSS -->
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <!-- Magnific Popup -->
    <link href="/css/magnific-popup.css" rel="stylesheet">
    <!-- Owl carousel -->
    <link href="/css/owl.carousel.css" rel="stylesheet">

    <!-- CSS for this page -->

    <!-- Syntax highlighting -->
    <link href="/css/syntax.css" rel="stylesheet">


    <!--[if lte IE 8]>
    <script src="/js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="/css/main.css"/>
    <!--[if lte IE 9]>
    <link rel="stylesheet" href="/css/ie9.css"/><![endif]-->
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/css/ie8.css"/><![endif]-->

    <!-- Custom CSS. Type your CSS code in custom.css file -->
    <link href="/css/custom.css" rel="stylesheet">

    <!-- Vertical timeline -->
	<link rel="stylesheet" href="/css/vertical-timeline/style.css"> <!-- Resource style -->

    <!-- Favicon -->
    <link rel="shortcut icon" href="#">

    <script src="https://use.typekit.net/gzh0mbm.js"></script>
    <script>
        try {
            Typekit.load({async: true});
        } catch (e) {
        }
    </script>
</head>

<body>
<div id="header-image"></div>


<!-- Page Wrapper -->
<div id="page-wrapper">

        <!-- Header -->
    <header id="header">
        <h1>
            <a href="/">
                JWorks Tech Blog
            </a>
        </h1>

        <nav>
            <a href="#menu">Menu</a>
            <form action="/search/" method="get" class="header-search search-form">
                <input type="text" id="search-box-header" name="query" placeholder="Search &hellip;">
            </form>
        </nav>
    </header>

    <!-- Menu -->
    <nav id="menu">
        <div class="inner">
            <h2>Menu</h2>
            <ul class="links">
                <li class="menu-item"><a href="/">Home</a></li>
                <li class="menu-item"><a href="/about">About Us</a></li>
                <li class="menu-item"><a href="/jobs">Jobs</a></li>
                <li class="menu-item"><a href="/launch-your-career">Career</a></li>
                <li class="menu-item"><a href="/search">Search</a></li>
                <li class="menu-item"><a href="/contact">Contact Us</a></li>
            </ul>
            <a href="#" class="close">Close</a>
        </div>
    </nav>

    <section id="banner">
        <header>
            <div class="inner">
                

                <h2>Node with TypeScript</h2>
                

                
                    Posted Jan 21, 2017


    in <a href="/categories/iot/">IoT</a>



    by
    
        <a href="/author/kevin-van-den-abeele/">Kevin Van den Abeele</a>
        
    



    <br/>
    <i class="fa fa-tags"></i>
    
        <a href="/tags/node/">Node</a>, 
    
        <a href="/tags/nodejs/">NodeJS</a>, 
    
        <a href="/tags/v8/">V8</a>, 
    
        <a href="/tags/javascript/">JavaScript</a>, 
    
        <a href="/tags/typescript/">TypeScript</a>, 
    
        <a href="/tags/iot/">IoT</a>, 
    
        <a href="/tags/internet-of-things/">Internet of Things</a>
    

                

                

            </div>
        </header>
    </section>

    <section id="wrapper">
        <div class="inner">
            <section id="one" class="wrapper spotlight style1 post-body">
    <div class="inner" style="text-align: left;">
        <div class="content">
            <blockquote>
  <p>NodeJS is a fantastic runtime to quickly and easily make projects.
However as these projects tend to grow larger and larger, the shortcomings of JavaScript become more and more visible.
This blog post will take a look at using TypeScript to write your Node application making it much more readable, introducing more OO like concepts whilst also making your code less error prone.</p>
</blockquote>

<h3 id="nodejs-and-its-use-cases">NodeJS and its use cases</h3>

<p style="text-align: center;">
  <img class="image fit" style="width: 650px; margin:0px auto;" alt="NodeJS Powered by the V8 JavaScript engine" src="/img/node-with-typescript/V8-engine.jpg" />
</p>

<p>NodeJS has many use cases.
It is an easy to pickup and use runtime.
It uses Google’s V8 JavaScript engine to interpret and run JavaScript code.
The user does not have to worry about threading.
This is taken care off by the runtime.
You write your code and make use of the many asynchronous operations provided by Node.
This will take care of any multithreading for you.
However, as you will read later in this blog post, making use of multiple Node instances to divide work is still possible!
More on that later!
<br /><br />
Node can be used for a variety of tasks:</p>
<ul>
  <li>Small yet efficient web server</li>
  <li>Code playground, test something quickly</li>
  <li>Automation and tooling, instead of using ruby/python/…</li>
  <li>IoT, Raspberry pi’s and other devices that can run Node!</li>
</ul>

<p><br /><br />
However, you should not use node for computationally heavy tasks!
While the V8 engine is highly performant, there are other much more performant options available for computationally heavy operations!
<br /><br />
This blog post is not meant for people who have no NodeJS experience!
Below are some resources for those that are new to the platform:</p>
<ul>
  <li><a href="https://nodejs.org/en/">The main NodeJS website</a></li>
  <li><a href="https://docs.npmjs.com/">The Node Package Manager</a></li>
  <li><a href="https://www.codeschool.com/courses/real-time-web-with-node-js">Code school intro to NodeJS</a></li>
</ul>

<h3 id="the-old-way-using-plain-javascript">The old way, using plain JavaScript</h3>

<p style="text-align: center;">
  <img class="image fit" alt="JavaScript" src="/img/node-with-typescript/javascript.jpg" />
</p>

<p>Since NodeJS uses Google’s V8 JavaScript engine, it speaks for itself that node interprets and runs regular JavaScript code.
This has some pros and cons.
While it is an easy language to pick up, it can be hard to master.
Javascript has always had some quirks and getting to know and how to avoid these can be tricky!
It also does not require any compilation, which makes running your code very easy.
However, this also removes any help from the compiler as no compile time checks are performed.
No type checking, no checking for illogical structures or things that will just not work.
<br /><br />
Code for Node can be run by simple opening a command prompt or terminal window and typing</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">    node

    </code></pre></figure>

<p>This will start a Node instance and present you with an interpreter.
You can now type commands and press return to execute them.
This can be handy to test something quickly.
<br /><br />
It is also possible to run a JavaScript file directly.
This can be done via:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">    node path/to/javascript-file.js

    </code></pre></figure>

<p><br />
However, most of the time you will not be using this way of running code.
Most of the time you will use npm to install your dependencies and start the node instance:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">    npm install
    npm start

    </code></pre></figure>

<p>This reads the package.json file and executes the scripts contained inside it.</p>

<blockquote>
  <p>Extensive documentation about the package.json file can be found on the <a href="https://docs.npmjs.com/files/package.json">NPM website</a></p>
</blockquote>

<h3 id="typescript-you-say">TypeScript you say!?</h3>

<p style="text-align: center;">
  <img class="image fit" alt="TypeScript" src="/img/node-with-typescript/typescript.jpg" />
</p>

<p>TypeScript has been around for some years now.
TypeScript is a superset of JavaScript.
It uses the same syntax but adds among other things compile time type checking.
It also adds a more Object Oriented model.
A detailed explanation of the differences of the prototype based JavaScript and a more Object Oriented language can be found on the
<a href="https://developer.mozilla.org/nl/docs/Web/JavaScript/Guide/Details_of_the_Object_Model">Mozilla Developer website</a>
<br /><br /></p>

<p><a href="https://www.typescriptlang.org/">TypeScript developed mainly by Microsoft</a> and is completely open source!
This means developers can make suggestions and report bugs (and even fix these bugs if they want).</p>
<blockquote>
  <p>TypeScript is a typed superset of JavaScript that compiles to plain JavaScript.
 Any browser. Any host. Any OS. Open source.</p>
</blockquote>

<p><br /><br />
<a href="https://www.typescriptlang.org/docs/tutorial.html">TypeScript is very well documented</a> and getting started with the language is fairly easy.
A lot of common development tools have support for TypeScript syntax checking.
These include, but are not limited to:</p>
<ul>
  <li>Intellij</li>
  <li>Webstorm</li>
  <li>Atom</li>
  <li>Visual Studio Code</li>
  <li>…</li>
</ul>

<p><br /><br />
As Node applications regularly use other NPM dependencies it is required for the TypeScript compiler to know about these dependencies and what types they use.
You could make or generate these typings yourself.
However, you can easily find these typings on <a href="https://microsoft.github.io/TypeSearch/">TypeSearch</a> website.
The most commonly used dependencies have their typings available here!
<br /></p>

<p>You can add the typings to the dependencies in the package.json file.</p>

<figure class="highlight"><pre><code class="language-coffeescript" data-lang="coffeescript">    <span class="s">"dependencies"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s">"typescript"</span><span class="o">:</span> <span class="s">"2.0.8"</span><span class="p">,</span>

        <span class="s">"@types/node"</span><span class="o">:</span> <span class="s">"0.0.2"</span><span class="p">,</span>
        <span class="s">"@types/mime"</span><span class="o">:</span> <span class="s">"0.0.29"</span><span class="p">,</span>
        <span class="s">"@types/johnny-five"</span><span class="o">:</span> <span class="s">"0.0.30"</span><span class="p">,</span>
        <span class="s">"@types/serialport"</span><span class="o">:</span> <span class="s">"4.0.6"</span><span class="p">,</span>

        <span class="s">"mime"</span><span class="o">:</span> <span class="s">"1.3.4"</span><span class="p">,</span>
        <span class="s">"johnny-five"</span><span class="o">:</span> <span class="s">"0.10.6"</span><span class="p">,</span>
        <span class="s">"serialport"</span><span class="o">:</span> <span class="s">"4.0.7"</span>
    <span class="p">}</span>

    </code></pre></figure>

<h3 id="making-it-all-work-an-example">Making it all work: An example</h3>

<p>A few years back I started working on my own server application to host some web content and provide REST services.
The code was written in JavaScript and ran on a Raspberry Pi 2 (by now a pi 3).
For those of you that are interested the old code can be found on the following Github repositories:</p>
<ul>
  <li><a href="https://github.com/beele/WeatherGenie">WeatherGenie</a> This was the initial implementation, a simple weather web application for checking the weather conditions for any city in Belgium</li>
  <li><a href="https://github.com/ordina-jworks/lora-iot-demo">LoRa-IoT-Demo</a> The second, extended iteration, based on the code from the WeatherGenie application.
Because with the advent of IoT we needed a simple to extend/run/maintain solution to create IoT demos for clients.</li>
  <li><a href="https://github.com/ordina-jworks/NodeSimpleServer">NodeSimpleServer</a> The third and current iteration. Written from the ground up in TypeScript and completely reworked to work better and be more maintainable.
This is the application that will be detailed below!</li>
</ul>

<h2 id="node-simple-server-high-level-architecture">Node Simple Server: High level architecture</h2>

<p style="text-align: center;">
  <img class="image fit" alt="High level architecture" src="/img/node-with-typescript/high-level-arch.png" />
</p>

<p>The Application starts in app.ts under the main src folder.
This is the entry point for the application.
This file contains the actual master instance code.
The master instance is in charge of forking the workers and reviving them if they die.
The master is also used to pass messages between the workers For this a specialized <code class="highlighter-rouge">MessageHandler</code> singleton is used.
This <code class="highlighter-rouge">MessageHandler</code> instance (one per worker) is used to relay messages.
The master instance itself will not execute any application logic.
Its purpose is to manage the other workers and be the message bridge.
<br /><br /></p>

<figure class="highlight"><pre><code class="language-coffeescript" data-lang="coffeescript">    <span class="o">/**</span>
     <span class="o">*</span> <span class="nx">Forks</span> <span class="nx">the</span> <span class="nx">workers</span><span class="p">,</span> <span class="nx">there</span> <span class="nx">will</span> <span class="nx">always</span> <span class="nx">be</span> <span class="nx">one</span> <span class="nx">DataBroker</span> <span class="o">and</span> <span class="nx">one</span> <span class="nx">IntervalWorker</span><span class="p">.</span>
     <span class="o">*</span> <span class="nx">HTTPWorker</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">created</span> <span class="nx">based</span> <span class="no">on</span> <span class="nx">the</span> <span class="nx">number</span> <span class="k">of</span> <span class="nx">cpu</span> <span class="nx">cores</span><span class="p">.</span> <span class="na">If</span> <span class="nx">less</span> <span class="nx">than</span> <span class="nx">two</span> <span class="nx">cores</span> <span class="nx">are</span> <span class="nx">available</span>
     <span class="o">*</span> <span class="nx">two</span> <span class="nx">http</span> <span class="nx">workers</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">created</span><span class="p">.</span>
     <span class="o">*/</span>
    <span class="nx">private</span> <span class="nx">forkWorkers</span> <span class="o">=</span> <span class="p">()</span><span class="o">:</span> <span class="nx">void</span> <span class="o">=&gt;</span><span class="p">{</span>
        <span class="o">//</span><span class="nx">Fork</span> <span class="nx">data</span> <span class="nx">broker</span><span class="p">.</span>
        <span class="k">this</span><span class="p">.</span><span class="na">databroker</span> <span class="o">=</span> <span class="nx">cluster</span><span class="p">.</span><span class="na">fork</span><span class="p">({</span><span class="na">name</span><span class="o">:</span> <span class="s">'broker'</span><span class="p">,</span> <span class="na">debug</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="na">isDebug</span><span class="p">});</span>

        <span class="o">//</span><span class="nx">Fork</span> <span class="nx">interval</span> <span class="nx">worker</span><span class="p">.</span>
        <span class="k">this</span><span class="p">.</span><span class="na">intervalWorker</span> <span class="o">=</span> <span class="nx">cluster</span><span class="p">.</span><span class="na">fork</span><span class="p">({</span><span class="na">name</span><span class="o">:</span> <span class="s">'interval'</span><span class="p">,</span> <span class="na">debug</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="na">isDebug</span><span class="p">});</span>

        <span class="o">//</span><span class="nx">Fork</span> <span class="nx">normal</span> <span class="nx">server</span> <span class="nx">worker</span> <span class="nx">instances</span><span class="p">.</span> <span class="na">These</span> <span class="nx">will</span> <span class="nx">handle</span> <span class="nx">all</span> <span class="nx">HTTP</span> <span class="nx">requests</span><span class="p">.</span>
        <span class="nx">let</span> <span class="na">cores</span><span class="o">:</span><span class="nx">number</span>                <span class="o">=</span> <span class="nx">os</span><span class="p">.</span><span class="na">cpus</span><span class="p">().</span><span class="na">length</span><span class="p">;</span>
        <span class="nx">let</span> <span class="na">numberOfHttpWorkers</span><span class="o">:</span><span class="nx">number</span>  <span class="o">=</span> <span class="nx">cores</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">cores</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">console</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="s">'There are '</span> <span class="o">+</span> <span class="nx">cores</span> <span class="o">+</span> <span class="s">' cores available, starting '</span> <span class="o">+</span> <span class="nx">numberOfHttpWorkers</span> <span class="o">+</span> <span class="s">' HTTP workers...'</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">let</span> <span class="na">i</span><span class="o">:</span><span class="nx">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">numberOfHttpWorkers</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">let</span> <span class="nx">worker</span> <span class="o">=</span> <span class="nx">cluster</span><span class="p">.</span><span class="na">fork</span><span class="p">({</span><span class="na">name</span><span class="o">:</span> <span class="s">'http'</span><span class="p">,</span> <span class="na">debug</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="na">isDebug</span><span class="p">});</span>
            <span class="k">this</span><span class="p">.</span><span class="na">httpWorkers</span><span class="p">.</span><span class="na">push</span><span class="p">(</span><span class="nx">worker</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="o">//</span><span class="nx">Revive</span> <span class="nx">workers</span> <span class="k">if</span> <span class="nx">they</span> <span class="nx">die</span><span class="o">!</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="na">isDebug</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cluster</span><span class="p">.</span><span class="na">on</span><span class="p">(</span><span class="s">'exit'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="na">reviveWorker</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    </code></pre></figure>

<p>The master will create a number of workers:</p>
<ul>
  <li><code class="highlighter-rouge">HttpWorker</code>: Each <code class="highlighter-rouge">HttpWorker</code> is an endpoint for requests to be received.
There will always be a minimum of two HttpWorkers created.
If more CPU cores are available, more HttpWorkers are created.</li>
  <li><code class="highlighter-rouge">DataBroker</code>: For the application there is one <code class="highlighter-rouge">DataBroker</code> worker instance.
This worker handles CRUD operations for data (for now in memory only).</li>
  <li><code class="highlighter-rouge">IntervalWorker</code>: For the application there is one <code class="highlighter-rouge">IntervalWorker</code> instance.
This worker can run code periodically and is used to connect to other devices such as Arduino’s and the Raspberry Pi I/O pins.
<br />
These workers are created by a <code class="highlighter-rouge">WorkerFactory</code>, as the master forks new Node instances, a process variable is set, the factory uses this to see which type the node instance should become.
Each type of worker instance implements the basic <code class="highlighter-rouge">NodeWorker</code> interface.
Each implementation will be detailed below.</li>
</ul>

<h2 id="handling-http-requests-the-httpworker">Handling HTTP requests: The HttpWorker</h2>
<p>Each <code class="highlighter-rouge">HttpWorker</code> instance will create a <code class="highlighter-rouge">Server</code> instance.
This instance will be used to receive HTTP requests.
Node will automatically load balance requests between all instances that register a server on the same port.
Simply put all HttpWorkers compete for the next request, the least burdened process (depending on OS/CPU process affinity) will be given the next Http request to handle.</p>

<p>The <code class="highlighter-rouge">Server</code> class will also register the endpoints that are known to the application and can be handled.
The <code class="highlighter-rouge">EndpointManager</code> is used to register endpoints.
An <code class="highlighter-rouge">EndPoint</code> has a path, a method to execute and optional parameters.
A <code class="highlighter-rouge">Parameter</code> is provided with a Generic type for compile time type checking, a name which should be used in the url, a description that provides information what the parameter should contain and an optional <code class="highlighter-rouge">ParameterValidator</code>.
A <code class="highlighter-rouge">ParameterValidator</code> is used to validate the <code class="highlighter-rouge">Parameter</code> at runtime.
If the check fails an error is shown to the user.</p>

<figure class="highlight"><pre><code class="language-coffeescript" data-lang="coffeescript">    <span class="o">/**</span>
     <span class="o">*</span> <span class="nx">Maps</span> <span class="nx">the</span> <span class="nx">default</span> <span class="nx">endpoints</span><span class="p">.</span>
     <span class="o">*</span> <span class="nx">Endpoints</span> <span class="nx">can</span> <span class="nx">always</span> <span class="nx">be</span> <span class="nx">added</span> <span class="nx">at</span> <span class="nx">any</span> <span class="nx">other</span> <span class="nx">location</span> <span class="o">and</span> <span class="nx">point</span> <span class="k">in</span> <span class="nx">time</span><span class="p">.</span>
     <span class="o">*</span> <span class="nx">This</span> <span class="nx">can</span> <span class="nx">be</span> <span class="nx">done</span> <span class="k">by</span> <span class="nx">getting</span> <span class="nx">the</span> <span class="nx">instance</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">EndPointManager</span> <span class="o">and</span> <span class="nx">calling</span> <span class="nx">the</span> <span class="nx">registerEndpoint</span> <span class="nx">method</span><span class="p">.</span>
     <span class="o">*/</span>
    <span class="nx">private</span> <span class="nx">mapRestEndpoints</span> <span class="o">=</span> <span class="p">()</span><span class="o">:</span> <span class="nx">void</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">endpointManager</span><span class="p">.</span><span class="na">registerEndpoint</span><span class="p">(</span>
            <span class="k">new</span> <span class="nx">EndPoint</span><span class="p">(</span>
                <span class="s">'/'</span><span class="p">,</span>
                <span class="nx">GenericEndpoints</span><span class="p">.</span><span class="na">index</span><span class="p">,</span>
                <span class="no">null</span>
            <span class="p">)</span>
        <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="na">endpointManager</span><span class="p">.</span><span class="na">registerEndpoint</span><span class="p">(</span>
            <span class="k">new</span> <span class="nx">EndPoint</span><span class="p">(</span>
                <span class="s">'/endpoints'</span><span class="p">,</span>
                <span class="nx">GenericEndpoints</span><span class="p">.</span><span class="na">listEndpoints</span><span class="p">,</span>
                <span class="no">null</span>
            <span class="p">)</span>
        <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="na">endpointManager</span><span class="p">.</span><span class="na">registerEndpoint</span><span class="p">(</span>
            <span class="k">new</span> <span class="nx">EndPoint</span><span class="p">(</span>
                <span class="s">'/helloworld'</span><span class="p">,</span>
                <span class="nx">GenericEndpoints</span><span class="p">.</span><span class="na">helloworld</span><span class="p">,</span>
                <span class="p">[</span><span class="k">new</span> <span class="nx">Parameter</span><span class="o">&lt;</span><span class="nx">string</span><span class="p">,</span> <span class="no">null</span><span class="p">,</span> <span class="no">null</span><span class="o">&gt;</span><span class="p">(</span><span class="s">'name'</span><span class="p">,</span> <span class="s">'string field containing the name'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">HelloWorldValidatorImpl</span><span class="p">())]</span>
            <span class="p">)</span>
        <span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="na">endpointManager</span><span class="p">.</span><span class="na">registerEndpoint</span><span class="p">(</span>
            <span class="k">new</span> <span class="nx">EndPoint</span><span class="p">(</span>
                <span class="s">'/arduino/setArduinoMethod'</span><span class="p">,</span>
                <span class="nx">ArduinoEndpoint</span><span class="p">.</span><span class="na">setArduinoMethod</span><span class="p">,</span>
                <span class="p">[</span><span class="k">new</span> <span class="nx">Parameter</span><span class="o">&lt;</span><span class="nx">string</span><span class="p">,</span> <span class="no">null</span><span class="p">,</span> <span class="no">null</span><span class="o">&gt;</span><span class="p">(</span><span class="s">'method'</span><span class="p">,</span> <span class="s">'string field that contains the method used for adruino implementations'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">ArduinoMethodValidatorImpl</span><span class="p">())]</span>
            <span class="p">)</span>
        <span class="p">);</span>
    <span class="p">};</span>

    </code></pre></figure>

<p>The <code class="highlighter-rouge">Server</code> instance forwards all requests to the <code class="highlighter-rouge">Router</code> instance.
As the name suggests this will perform the routing.
It will see if a resource is requested or and endpoint has been called.
If a resource is requested it will be served if found.
If an endpoint has been called, that endpoint will be executed and passed the parameters that were entered, but only after the correct amount of parameters has been passed and they are all valid.</p>

<h2 id="handling-data-the-databroker">Handling data: The DataBroker</h2>
<p>The <code class="highlighter-rouge">DataBroker</code> is the Node instance in the application that will save and retrieve data.
For the time being it is sufficient to only have in memory ‘caches’ on which basic CRUD operations can be performed.
All methods on the <code class="highlighter-rouge">DataBroker</code> are called by sending an <code class="highlighter-rouge">IPCRequest</code> with the data that needs to be saved of the instruction for what data should be retrieved.
The <code class="highlighter-rouge">DataBroker</code> will reply to the original worker by sending an <code class="highlighter-rouge">IPCReply</code> with the result of the operation.</p>

<p>The <code class="highlighter-rouge">DataBroker</code> for now only has a concept of caches.
A cache has a name, type and values (of said type).
Values can be retrieved, added, updated and deleted from the caches.
Caches can be retrieved, added and deleted at runtime.</p>

<h2 id="handling-asynchronous-tasks-the-intervalworker">Handling asynchronous tasks: The IntervalWorker</h2>
<p>The <code class="highlighter-rouge">IntervalWorker</code> as its name suggest performs tasks at a certain interval.
It is also used for other asynchronous workloads, such as connecting to an Arduino and running Arduino/Raspberry pi Johhny-Five scenarios.
The <code class="highlighter-rouge">IntervalWorker</code> is handy when you need for example to update the content of a cache every so often.
<br /><br />
It can also run Arduino scenarios.
These are Implementations that contain logic to perform actions on the Arduino or in response to something that happens on the Arduino.
The <code class="highlighter-rouge">IntervalWorker</code> picks up what type of Arduino <code class="highlighter-rouge">Scenario</code> you want to run and starts the logic.</p>

<figure class="highlight"><pre><code class="language-coffeescript" data-lang="coffeescript">    <span class="o">/**</span>
     <span class="o">*</span> <span class="nx">Sets</span> <span class="nx">up</span> <span class="nx">the</span> <span class="nx">connection</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">Arduino</span> <span class="o">and</span> <span class="nx">starts</span> <span class="nx">the</span> <span class="nx">desired</span> <span class="nx">Arduino</span> <span class="nx">Scenario</span><span class="p">.</span>
     <span class="o">*/</span>
    <span class="nx">private</span> <span class="nx">setupArduino</span> <span class="o">=</span> <span class="p">()</span><span class="o">:</span> <span class="nx">void</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">arduino</span><span class="p">.</span><span class="na">enableArduino</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">arduino</span><span class="p">.</span><span class="na">useSerialOverJohnnyFive</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="na">arduino</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArduinoSerial</span><span class="p">(</span>
                    <span class="k">this</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">arduino</span><span class="p">.</span><span class="na">serialPortName</span><span class="p">,</span>
                    <span class="k">this</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">arduino</span><span class="p">.</span><span class="na">serialPortBaudRate</span><span class="p">,</span>
                    <span class="k">new</span> <span class="nx">PingScenario</span><span class="p">()</span>
                <span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="na">arduino</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArduinoJohnny</span><span class="p">(</span><span class="k">new</span> <span class="nx">BlinkScenario</span><span class="p">());</span>
            <span class="p">}</span>
            <span class="k">this</span><span class="p">.</span><span class="na">arduino</span><span class="p">.</span><span class="na">init</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="s">'Skipping arduino setup, disabled in settings!'</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    </code></pre></figure>

<p>There are two Arduino implementations available.
Both can execute a <code class="highlighter-rouge">Scenario</code>.
The first and simplest implementation is the Johnny-Five Arduino implementation.
This allows you to make use of the Johnny-Five framework to write dynamic code for the Arduino that can change at runtime.
This is possible because it uses the StandardFirmata firmware.
Johnny-Five supports a lot of components and peripherals.
<a href="http://johnny-five.io/api/">Their website</a> has extensive documentation and very clear examples.
Johnny-Five also supports the Raspberry PI I/O pins.
This allows it to be used on a Raspberry pi also.
<br />
The second Arduino implementation uses no framework and communication is done via regular serial.
In the type of scenarios you have to handle all the serial communication yourself.
You also have to write Arduino firmware and thus it cannot be dynamically updated at runtime.
Use this Arduino implementation if some component is incompatible or not supported by Johnny-Five.</p>

<h2 id="inter-process-messaging-communicating-between-different-node-instances">Inter Process Messaging: Communicating between different Node instances</h2>
<p>Having all these different worker instances is quite handy.
However they are of not much use if there cannot be any communication between them.
Each Node instance has its own allocated memory and cannot access variables or call methods on other instances.
The Node cluster and process framework provide the option to send messages between Node instances.
<br /><br />
The <code class="highlighter-rouge">IPCMessage</code> instances that are sent exist in two forms.</p>
<ul>
  <li><code class="highlighter-rouge">IPCRequest</code>: This is the initial message that is sent to a target.</li>
  <li><code class="highlighter-rouge">IPCReply</code>: This is the response (if any) from the target back to the original caller.
<br /><br /></li>
</ul>

<p>This allows for easy two way communication and identification whether the message was a reply to an earlier message.
Messages can be sent with or without a callback.
The callback is executed when a reply to the original message is received.
Because only basic data types can be sent across Node instances the <code class="highlighter-rouge">MessageManager</code> instance of the caller stores the callback reference and generates an unique id for said callback.
This allows the application to send the callback ID across Node instances and execute it when it arrives back at the caller.</p>

<figure class="highlight"><pre><code class="language-coffeescript" data-lang="coffeescript">    <span class="o">/**</span>
         <span class="o">*</span> <span class="nx">MessageManager</span> <span class="nx">singleton</span> <span class="k">class</span><span class="p">.</span>
         <span class="o">*</span> <span class="nx">This</span> <span class="k">class</span> <span class="nx">has</span> <span class="nx">an</span> <span class="nx">array</span> <span class="k">of</span> <span class="nx">tuples</span> <span class="k">of</span> <span class="nx">string</span> <span class="o">and</span> <span class="nb">Function</span><span class="p">.</span>
         <span class="o">*</span> <span class="nx">The</span> <span class="nx">string</span> <span class="nx">field</span> <span class="o">is</span> <span class="nx">the</span> <span class="nx">callbackId</span> <span class="o">and</span> <span class="nx">the</span> <span class="nb">Function</span> <span class="o">is</span> <span class="nx">the</span> <span class="nx">actual</span> <span class="nx">callback</span><span class="p">.</span>
         <span class="o">*</span> <span class="nx">The</span> <span class="nx">message</span> <span class="nx">manager</span> <span class="o">is</span> <span class="nx">a</span> <span class="nx">per</span> <span class="nx">worker</span> <span class="nx">instance</span> <span class="nx">that</span> <span class="nx">can</span> <span class="nx">only</span> <span class="nx">execute</span> <span class="nx">callbacks</span> <span class="no">on</span> <span class="nx">the</span> <span class="nx">same</span> <span class="nx">worker</span><span class="p">.</span>
         <span class="o">*</span> <span class="nx">The</span> <span class="nx">integration</span> <span class="nx">with</span> <span class="nx">the</span> <span class="nx">IPC</span> <span class="nx">framework</span> <span class="nx">allows</span> <span class="nx">messages</span> <span class="nx">to</span> <span class="nx">be</span> <span class="nx">sent</span> <span class="nx">to</span> <span class="nx">other</span> <span class="nx">workers</span> <span class="o">and</span> <span class="nx">replies</span> <span class="nx">to</span> <span class="nx">be</span> <span class="nx">sent</span> <span class="nx">back</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">original</span> <span class="nx">worker</span><span class="p">.</span>
         <span class="o">*</span> <span class="nx">It</span> <span class="o">is</span> <span class="nx">important</span> <span class="nx">that</span> <span class="nx">the</span> <span class="nx">original</span> <span class="nx">worker</span> <span class="o">is</span> <span class="nx">called</span> <span class="nx">to</span> <span class="nx">execute</span> <span class="nx">the</span> <span class="nx">callback</span> <span class="nx">since</span> <span class="nx">a</span> <span class="nx">function</span> <span class="nx">cannot</span> <span class="nx">cross</span> <span class="nx">a</span> <span class="nx">node</span> <span class="nx">instance</span><span class="o">!</span>
         <span class="o">*</span>
         <span class="o">*</span> <span class="nx">This</span> <span class="nx">singleton</span> <span class="nx">can</span> <span class="nx">be</span> <span class="nx">used</span> <span class="nx">to</span> <span class="nx">manage</span> <span class="nx">IPC</span> <span class="nx">messages</span><span class="p">.</span>
         <span class="o">*/</span>
        <span class="nx">export</span> <span class="k">class</span> <span class="nx">MessageManager</span> <span class="p">{</span>

            <span class="nx">private</span> <span class="nx">static</span> <span class="na">instance</span><span class="o">:</span> <span class="nx">MessageManager</span>         <span class="o">=</span> <span class="no">null</span><span class="p">;</span>
            <span class="nx">private</span> <span class="na">callbacks</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="p">[</span><span class="nx">string</span><span class="p">,</span> <span class="nb">Function</span><span class="p">]</span><span class="o">&gt;</span>    <span class="o">=</span> <span class="no">null</span><span class="p">;</span>
            <span class="nx">private</span> <span class="na">workerId</span><span class="o">:</span> <span class="nx">string</span>                        <span class="o">=</span> <span class="no">null</span><span class="p">;</span>

            <span class="o">/**</span>
             <span class="o">*</span> <span class="nx">Private</span> <span class="nx">constructor</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">singleton</span><span class="p">.</span>
             <span class="o">*/</span>
            <span class="nx">private</span> <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="na">callbacks</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="k">this</span><span class="p">.</span><span class="na">workerId</span> <span class="o">=</span> <span class="nx">cluster</span><span class="p">.</span><span class="na">worker</span><span class="p">.</span><span class="na">id</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="o">/**</span>
             <span class="o">*</span> <span class="nx">Use</span> <span class="k">this</span> <span class="nx">method</span> <span class="nx">to</span> <span class="nx">get</span> <span class="nx">the</span> <span class="nx">instance</span> <span class="k">of</span> <span class="k">this</span> <span class="nx">singleton</span> <span class="k">class</span><span class="p">.</span>
             <span class="o">*</span>
             <span class="o">*</span> <span class="vi">@</span><span class="na">returns</span> <span class="p">{</span><span class="nx">MessageManager</span><span class="p">}</span> <span class="nx">The</span> <span class="nx">instance</span> <span class="k">of</span> <span class="k">this</span> <span class="nx">singleton</span> <span class="k">class</span><span class="p">.</span>
             <span class="o">*/</span>
            <span class="nx">public</span> <span class="nx">static</span> <span class="nx">getInstance</span><span class="p">()</span><span class="o">:</span> <span class="nx">MessageManager</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">MessageManager</span><span class="p">.</span><span class="na">instance</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">MessageManager</span><span class="p">.</span><span class="na">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MessageManager</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">MessageManager</span><span class="p">.</span><span class="na">instance</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="o">/**</span>
             <span class="o">*</span> <span class="nx">Sends</span> <span class="nx">an</span> <span class="nx">IPCMessage</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">subtype</span> <span class="nx">IPCRequest</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">given</span> <span class="nx">MessageTarget</span> <span class="p">(</span><span class="nx">one</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">three</span> <span class="nx">worker</span> <span class="nx">types</span><span class="p">).</span>
             <span class="o">*</span> <span class="nx">A</span> <span class="nx">target</span> <span class="nx">function</span> <span class="o">is</span> <span class="nx">also</span> <span class="nx">given</span> <span class="o">and</span> <span class="nx">contains</span> <span class="nx">the</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">function</span> <span class="nx">that</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">executed</span> <span class="no">on</span> <span class="nx">the</span> <span class="nx">target</span><span class="p">.</span>
             <span class="o">*</span> <span class="nx">The</span> <span class="nx">target</span> <span class="nx">should</span> <span class="nx">implement</span> <span class="nx">a</span> <span class="nx">specific</span> <span class="nx">handler</span> <span class="o">or</span> <span class="k">switch</span> <span class="nx">statement</span> <span class="nx">to</span> <span class="nx">handle</span> <span class="nx">these</span> <span class="nx">different</span> <span class="nx">target</span> <span class="nx">function</span> <span class="nx">names</span><span class="p">.</span>
             <span class="o">*</span> <span class="nx">This</span> <span class="nx">message</span> <span class="o">is</span> <span class="nx">sent</span> <span class="nx">without</span> <span class="nx">a</span> <span class="nx">callback</span><span class="p">.</span> <span class="na">This</span> <span class="nx">means</span> <span class="nx">that</span> <span class="k">when</span> <span class="nx">the</span> <span class="nx">target</span> <span class="nx">function</span> <span class="nx">has</span> <span class="nx">finished</span> <span class="no">no</span> <span class="nx">reply</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">sent</span> <span class="nx">to</span> <span class="nx">inform</span> <span class="nx">the</span> <span class="nx">caller</span><span class="p">.</span>
             <span class="o">*</span>
             <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">payload</span> <span class="nx">The</span> <span class="nx">payload</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">can</span> <span class="nx">be</span> <span class="k">of</span> <span class="nx">any</span> <span class="nx">kind</span><span class="p">.</span>
             <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">messageTarget</span> <span class="nx">The</span> <span class="nx">MessageTarget</span><span class="p">,</span> <span class="nx">being</span> <span class="nx">one</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">three</span> <span class="nx">types</span> <span class="k">of</span> <span class="nx">workers</span><span class="p">.</span>
             <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">targetFunctionName</span> <span class="nx">The</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">function</span> <span class="nx">to</span> <span class="nx">be</span> <span class="nx">executed</span> <span class="no">on</span> <span class="nx">the</span> <span class="nx">target</span><span class="p">.</span> <span class="na">This</span> <span class="nx">value</span> <span class="o">is</span> <span class="nx">NOT</span> <span class="nx">evaluated</span> <span class="k">by</span> <span class="nb">eval</span> <span class="k">for</span> <span class="nx">security</span> <span class="nx">reasons</span><span class="p">.</span>
             <span class="o">*/</span>
            <span class="nx">public</span> <span class="nx">sendMessage</span><span class="p">(</span><span class="na">payload</span><span class="o">:</span> <span class="nx">any</span><span class="p">,</span> <span class="na">messageTarget</span><span class="o">:</span> <span class="nx">MessageTarget</span><span class="p">,</span> <span class="na">targetFunctionName</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>
                <span class="nx">let</span> <span class="na">message</span><span class="o">:</span> <span class="nx">IPCMessage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">IPCRequest</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">workerId</span><span class="p">,</span> <span class="no">null</span><span class="p">,</span> <span class="nx">payload</span><span class="p">,</span> <span class="nx">messageTarget</span><span class="p">,</span> <span class="nx">targetFunctionName</span><span class="p">);</span>
                <span class="nx">process</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="o">/**</span>
             <span class="o">*</span> <span class="nx">Sends</span> <span class="nx">an</span> <span class="nx">IPCMessage</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">subtype</span> <span class="nx">IPCRequest</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">given</span> <span class="nx">MessageTarget</span> <span class="p">(</span><span class="nx">one</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">three</span> <span class="nx">worker</span> <span class="nx">types</span><span class="p">).</span>
             <span class="o">*</span> <span class="nx">A</span> <span class="nx">target</span> <span class="nx">function</span> <span class="o">is</span> <span class="nx">also</span> <span class="nx">given</span> <span class="o">and</span> <span class="nx">contains</span> <span class="nx">the</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">function</span> <span class="nx">that</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">executed</span> <span class="no">on</span> <span class="nx">the</span> <span class="nx">target</span><span class="p">.</span>
             <span class="o">*</span> <span class="nx">The</span> <span class="nx">target</span> <span class="nx">should</span> <span class="nx">implement</span> <span class="nx">a</span> <span class="nx">specific</span> <span class="nx">handler</span> <span class="o">or</span> <span class="k">switch</span> <span class="nx">statement</span> <span class="nx">to</span> <span class="nx">handle</span> <span class="nx">these</span> <span class="nx">different</span> <span class="nx">target</span> <span class="nx">function</span> <span class="nx">names</span><span class="p">.</span>
             <span class="o">*</span> <span class="nx">This</span> <span class="nx">message</span> <span class="o">is</span> <span class="nx">sent</span> <span class="nx">with</span> <span class="nx">a</span> <span class="nx">callback</span><span class="p">.</span> <span class="na">The</span> <span class="nx">callee</span> <span class="nx">sends</span> <span class="nx">a</span> <span class="k">new</span> <span class="nx">IPCMessage</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">subtype</span> <span class="nx">IPCReply</span> <span class="nx">to</span> <span class="nx">inform</span> <span class="nx">the</span> <span class="nx">caller</span> <span class="o">and</span> <span class="nx">provide</span> <span class="nx">it</span> <span class="nx">with</span> <span class="k">new</span> <span class="nx">information</span> <span class="k">if</span> <span class="nx">needed</span><span class="p">.</span>
             <span class="o">*</span> <span class="nx">A</span> <span class="nx">reply</span> <span class="nx">can</span> <span class="nx">be</span> <span class="nx">sent</span> <span class="k">by</span> <span class="nx">using</span> <span class="nx">the</span> <span class="nx">sendReply</span> <span class="nx">method</span> <span class="no">on</span> <span class="k">this</span> <span class="k">class</span><span class="p">.</span>
             <span class="o">*</span>
             <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">payload</span> <span class="nx">The</span> <span class="nx">payload</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">can</span> <span class="nx">be</span> <span class="k">of</span> <span class="nx">any</span> <span class="nx">kind</span><span class="p">.</span>
             <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">callback</span> <span class="nx">The</span> <span class="nx">function</span> <span class="nx">that</span> <span class="nx">should</span> <span class="nx">be</span> <span class="nx">called</span> <span class="k">when</span> <span class="nx">a</span> <span class="nx">reply</span> <span class="nx">has</span> <span class="nx">been</span> <span class="nx">received</span><span class="p">.</span>
             <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">messageTarget</span> <span class="nx">The</span> <span class="nx">MessageTarget</span><span class="p">,</span> <span class="nx">being</span> <span class="nx">one</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">three</span> <span class="nx">types</span> <span class="k">of</span> <span class="nx">workers</span><span class="p">.</span>
             <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">targetFunctionName</span> <span class="nx">The</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">function</span> <span class="nx">to</span> <span class="nx">be</span> <span class="nx">executed</span> <span class="no">on</span> <span class="nx">the</span> <span class="nx">target</span><span class="p">.</span> <span class="na">This</span> <span class="nx">value</span> <span class="o">is</span> <span class="nx">NOT</span> <span class="nx">evaluated</span> <span class="k">by</span> <span class="nb">eval</span> <span class="k">for</span> <span class="nx">security</span> <span class="nx">reasons</span><span class="p">.</span>
             <span class="o">*/</span>
            <span class="nx">public</span> <span class="nx">sendMessageWithCallback</span><span class="p">(</span><span class="na">payload</span><span class="o">:</span> <span class="nx">any</span><span class="p">,</span> <span class="na">callback</span><span class="o">:</span> <span class="nb">Function</span><span class="p">,</span> <span class="na">messageTarget</span><span class="o">:</span> <span class="nx">MessageTarget</span><span class="p">,</span> <span class="na">targetFunctionName</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>
                <span class="nx">let</span> <span class="na">callbackId</span><span class="o">:</span> <span class="nx">string</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="na">hrtime</span><span class="p">()</span>  <span class="o">+</span> <span class="s">"--"</span> <span class="o">+</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="na">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">6</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="na">callbacks</span><span class="p">.</span><span class="na">push</span><span class="p">([</span><span class="nx">callbackId</span><span class="p">,</span> <span class="nx">callback</span><span class="p">]);</span>

                <span class="nx">let</span> <span class="na">message</span><span class="o">:</span> <span class="nx">IPCMessage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">IPCRequest</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">workerId</span><span class="p">,</span> <span class="nx">callbackId</span><span class="p">,</span> <span class="nx">payload</span><span class="p">,</span> <span class="nx">messageTarget</span><span class="p">,</span> <span class="nx">targetFunctionName</span><span class="p">);</span>
                <span class="nx">process</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="o">/**</span>
             <span class="o">*</span> <span class="nx">Sends</span> <span class="o">and</span> <span class="nx">IPCMessage</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">subtype</span> <span class="nx">IPCReply</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">sender</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">original</span> <span class="nx">message</span><span class="p">.</span>
             <span class="o">*</span>
             <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">payload</span> <span class="nx">A</span> <span class="k">new</span> <span class="nx">payload</span> <span class="nx">to</span> <span class="nx">provide</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">original</span> <span class="nx">sender</span><span class="p">.</span>
             <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">originalMessage</span> <span class="nx">The</span> <span class="nx">message</span> <span class="nx">the</span> <span class="nx">sender</span> <span class="nx">originally</span> <span class="nx">sent</span><span class="p">.</span>
             <span class="o">*/</span>
            <span class="nx">public</span> <span class="nx">sendReply</span><span class="p">(</span><span class="na">payload</span><span class="o">:</span> <span class="nx">any</span><span class="p">,</span> <span class="na">originalMessage</span><span class="o">:</span> <span class="nx">IPCRequest</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>
                <span class="nx">let</span> <span class="na">reply</span><span class="o">:</span> <span class="nx">IPCMessage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">IPCReply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">workerId</span><span class="p">,</span> <span class="nx">payload</span><span class="p">,</span> <span class="nx">originalMessage</span><span class="p">);</span>
                <span class="nx">process</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="nx">reply</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="o">/**</span>
             <span class="o">*</span> <span class="nx">For</span> <span class="nx">a</span> <span class="nx">given</span> <span class="nx">callbackId</span> <span class="nx">execute</span> <span class="nx">the</span> <span class="nx">callback</span> <span class="nx">function</span><span class="p">.</span>
             <span class="o">*</span>
             <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">callbackId</span> <span class="nx">The</span> <span class="nx">callbackId</span> <span class="k">for</span> <span class="nx">which</span> <span class="nx">to</span> <span class="nx">execute</span> <span class="nx">the</span> <span class="nx">callback</span> <span class="nx">function</span><span class="p">.</span>
             <span class="o">*/</span>
            <span class="nx">public</span> <span class="nx">executeCallbackForId</span><span class="p">(</span><span class="na">callbackId</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span> <span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">let</span> <span class="nx">callbackEntry</span> <span class="k">of</span> <span class="k">this</span><span class="p">.</span><span class="na">callbacks</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">callbackEntry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nx">callbackId</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">callbackEntry</span><span class="p">[</span><span class="mi">1</span><span class="p">]();</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

    </code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;br/&gt; &lt;br/&gt;
</code></pre></div></div>

<figure class="highlight"><pre><code class="language-coffeescript" data-lang="coffeescript">    <span class="o">/**</span>
     <span class="o">*</span> <span class="nx">MessageHandler</span> <span class="nx">singleton</span> <span class="k">class</span><span class="p">.</span>
     <span class="o">*</span>
     <span class="o">*</span> <span class="nx">This</span> <span class="nx">singleton</span> <span class="nx">can</span> <span class="nx">be</span> <span class="nx">used</span> <span class="nx">to</span> <span class="nx">handle</span> <span class="nx">IPC</span> <span class="nx">messages</span><span class="p">.</span>
     <span class="o">*/</span>
    <span class="nx">export</span> <span class="k">class</span> <span class="nx">MessageHandler</span> <span class="p">{</span>

        <span class="nx">private</span> <span class="nx">static</span> <span class="na">instance</span><span class="o">:</span> <span class="nx">MessageHandler</span>         <span class="o">=</span> <span class="no">null</span><span class="p">;</span>
        <span class="nx">private</span> <span class="na">dataBroker</span> <span class="o">:</span> <span class="nx">cluster</span><span class="p">.</span><span class="na">Worker</span>             <span class="o">=</span> <span class="no">null</span><span class="p">;</span>
        <span class="nx">private</span> <span class="na">intervalWorker</span> <span class="o">:</span> <span class="nx">cluster</span><span class="p">.</span><span class="na">Worker</span>         <span class="o">=</span> <span class="no">null</span><span class="p">;</span>
        <span class="nx">private</span> <span class="na">httpWorkers</span> <span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">cluster</span><span class="p">.</span><span class="na">Worker</span><span class="o">&gt;</span>     <span class="o">=</span> <span class="no">null</span><span class="p">;</span>
        <span class="nx">public</span> <span class="na">emitter</span><span class="o">:</span> <span class="nx">EventEmitter</span>                    <span class="o">=</span> <span class="no">null</span><span class="p">;</span>

        <span class="o">/**</span>
         <span class="o">*</span> <span class="nx">Private</span> <span class="nx">constructor</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">singleton</span><span class="p">.</span>
         <span class="o">*/</span>
        <span class="nx">private</span> <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>

        <span class="p">}</span>

        <span class="o">/**</span>
         <span class="o">*</span> <span class="nx">Use</span> <span class="k">this</span> <span class="nx">method</span> <span class="nx">to</span> <span class="nx">get</span> <span class="nx">the</span> <span class="nx">instance</span> <span class="k">of</span> <span class="k">this</span> <span class="nx">singleton</span> <span class="k">class</span><span class="p">.</span>
         <span class="o">*</span>
         <span class="o">*</span> <span class="vi">@</span><span class="na">returns</span> <span class="p">{</span><span class="nx">MessageHandler</span><span class="p">}</span> <span class="nx">The</span> <span class="nx">instance</span> <span class="k">of</span> <span class="k">this</span> <span class="nx">singleton</span> <span class="k">class</span><span class="p">.</span>
         <span class="o">*/</span>
        <span class="nx">public</span> <span class="nx">static</span> <span class="nx">getInstance</span><span class="p">()</span><span class="o">:</span> <span class="nx">MessageHandler</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">MessageHandler</span><span class="p">.</span><span class="na">instance</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">MessageHandler</span><span class="p">.</span><span class="na">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MessageHandler</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">MessageHandler</span><span class="p">.</span><span class="na">instance</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="o">/**</span>
         <span class="o">*</span> <span class="nx">Initialises</span> <span class="nx">the</span> <span class="nx">MessageHandler</span> <span class="k">for</span> <span class="nx">being</span> <span class="nx">a</span> <span class="nx">handler</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">master</span> <span class="nx">NodeJS</span> <span class="nx">process</span><span class="p">.</span>
         <span class="o">*</span>
         <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">dataBroker</span> <span class="nx">The</span> <span class="nx">DataBroker</span> <span class="nx">worker</span> <span class="nx">instance</span><span class="p">.</span>
         <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">intervalWorker</span> <span class="nx">The</span> <span class="nx">IntervalWorker</span> <span class="nx">worker</span> <span class="nx">instance</span><span class="p">.</span>
         <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">httpWorkers</span> <span class="nx">The</span> <span class="nx">HTTPWorker</span> <span class="nx">worker</span> <span class="nx">instance</span><span class="p">.</span>
         <span class="o">*/</span>
        <span class="nx">public</span> <span class="nx">initForMaster</span> <span class="o">=</span> <span class="p">(</span><span class="na">dataBroker</span><span class="o">:</span> <span class="nx">cluster</span><span class="p">.</span><span class="na">Worker</span><span class="p">,</span> <span class="na">intervalWorker</span><span class="o">:</span> <span class="nx">cluster</span><span class="p">.</span><span class="na">Worker</span><span class="p">,</span> <span class="na">httpWorkers</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">cluster</span><span class="p">.</span><span class="na">Worker</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="na">dataBroker</span>     <span class="o">=</span> <span class="nx">dataBroker</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="na">intervalWorker</span> <span class="o">=</span> <span class="nx">intervalWorker</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="na">httpWorkers</span>    <span class="o">=</span> <span class="nx">httpWorkers</span><span class="p">;</span>

            <span class="k">this</span><span class="p">.</span><span class="na">emitter</span>        <span class="o">=</span> <span class="k">new</span> <span class="nx">EventEmitter</span><span class="p">();</span>
        <span class="p">};</span>

        <span class="o">/**</span>
         <span class="o">*</span> <span class="nx">Initialises</span> <span class="nx">the</span> <span class="nx">MessageHandler</span> <span class="k">for</span> <span class="nx">being</span> <span class="nx">a</span> <span class="nx">handler</span> <span class="k">for</span> <span class="nx">a</span> <span class="nx">slave</span> <span class="p">(</span><span class="nx">worker</span><span class="p">)</span> <span class="nx">NodeJS</span> <span class="nx">process</span><span class="p">.</span>
         <span class="o">*/</span>
        <span class="nx">public</span> <span class="nx">initForSlave</span> <span class="o">=</span> <span class="p">()</span><span class="o">:</span> <span class="nx">void</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="na">emitter</span>        <span class="o">=</span> <span class="k">new</span> <span class="nx">EventEmitter</span><span class="p">();</span>
        <span class="p">};</span>

        <span class="o">/*-----------------------------------------------------------------------------</span>
         <span class="o">------------------------------------------------------------------------------</span>
         <span class="o">--</span>                         <span class="nx">MASTER</span> <span class="nx">MESSAGE</span> <span class="nx">HANDLING</span>                          <span class="o">--</span>
         <span class="o">------------------------------------------------------------------------------</span>
         <span class="o">----------------------------------------------------------------------------*/</span>
        <span class="o">//</span><span class="na">TODO</span><span class="o">:</span> <span class="nx">Separate</span> <span class="nx">master</span> <span class="o">and</span> <span class="nx">slave</span> <span class="nx">message</span> <span class="nx">handling</span><span class="o">?</span>

        <span class="o">/**</span>
         <span class="o">*</span> <span class="nx">Handler</span> <span class="nx">function</span> <span class="k">for</span> <span class="nx">messages</span> <span class="nx">sent</span> <span class="k">by</span> <span class="nx">HTTPWorkers</span><span class="p">.</span>
         <span class="o">*</span> <span class="nx">Forwards</span> <span class="nx">the</span> <span class="nx">message</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">target</span><span class="p">.</span>
         <span class="o">*</span>
         <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">msg</span> <span class="nx">The</span> <span class="nx">IPCMessage</span> <span class="nx">as</span> <span class="nx">sent</span> <span class="k">by</span> <span class="nx">an</span> <span class="nx">HTTPWorker</span><span class="p">.</span>
         <span class="o">*/</span>
        <span class="nx">public</span> <span class="nx">onServerWorkerMessageReceived</span> <span class="o">=</span> <span class="p">(</span><span class="na">msg</span><span class="o">:</span> <span class="nx">IPCMessage</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="s">'Message received from server worker'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="na">targetHandler</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="o">/**</span>
         <span class="o">*</span> <span class="nx">Handler</span> <span class="nx">function</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">messages</span> <span class="nx">sent</span> <span class="k">by</span> <span class="nx">the</span> <span class="nx">IntervalWorker</span><span class="p">.</span>
         <span class="o">*</span> <span class="nx">Forwards</span> <span class="nx">the</span> <span class="nx">message</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">target</span><span class="p">.</span>
         <span class="o">*</span>
         <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">msg</span> <span class="nx">The</span> <span class="nx">IPCMessage</span> <span class="nx">as</span> <span class="nx">sent</span> <span class="k">by</span> <span class="nx">the</span> <span class="nx">IntervalWorker</span><span class="p">.</span>
         <span class="o">*/</span>
        <span class="nx">public</span> <span class="nx">onIntervalWorkerMessageReceived</span> <span class="o">=</span> <span class="p">(</span><span class="na">msg</span><span class="o">:</span> <span class="nx">IPCMessage</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="s">'Message received from interval worker'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="na">targetHandler</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="o">/**</span>
         <span class="o">*</span> <span class="nx">Handler</span> <span class="nx">function</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">messages</span> <span class="nx">sent</span> <span class="k">by</span> <span class="nx">the</span> <span class="nx">DataBroker</span><span class="p">.</span>
         <span class="o">*</span> <span class="nx">Forwards</span> <span class="nx">the</span> <span class="nx">message</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">target</span><span class="p">.</span>
         <span class="o">*</span>
         <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">msg</span> <span class="nx">The</span> <span class="nx">IPCMessage</span> <span class="nx">as</span> <span class="nx">sent</span> <span class="k">by</span> <span class="nx">the</span> <span class="nx">DataBroker</span><span class="p">.</span>
         <span class="o">*/</span>
        <span class="nx">public</span> <span class="nx">onDataBrokerMessageReceived</span> <span class="o">=</span> <span class="p">(</span><span class="na">msg</span><span class="o">:</span> <span class="nx">IPCMessage</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="s">'Message received from data broker'</span><span class="p">);</span>
            <span class="nx">cluster</span><span class="p">.</span><span class="na">workers</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="na">workerId</span><span class="p">].</span><span class="na">send</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="o">/**</span>
         <span class="o">*</span> <span class="nx">This</span> <span class="nx">method</span> <span class="o">is</span> <span class="nx">used</span> <span class="nx">to</span> <span class="nx">direct</span> <span class="nx">the</span> <span class="nx">IPCMessage</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">correct</span> <span class="nx">target</span> <span class="nx">as</span> <span class="nx">specified</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">message</span><span class="p">.</span>
         <span class="o">*</span> <span class="nx">This</span> <span class="nx">handler</span> <span class="nx">makes</span> <span class="nx">a</span> <span class="nx">distinction</span> <span class="nx">between</span> <span class="nx">messages</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">types</span> <span class="nx">IPCRequest</span> <span class="o">and</span> <span class="nx">IPCReply</span><span class="p">.</span>
         <span class="o">*</span>
         <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">msg</span> <span class="nx">The</span> <span class="nx">IPCMessage</span> <span class="nx">that</span> <span class="o">is</span> <span class="nx">to</span> <span class="nx">be</span> <span class="nx">forwarded</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">correct</span> <span class="nx">target</span><span class="p">.</span>
         <span class="o">*/</span>
        <span class="nx">private</span> <span class="nx">targetHandler</span> <span class="o">=</span> <span class="p">(</span><span class="na">msg</span><span class="o">:</span> <span class="nx">IPCMessage</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="na">type</span> <span class="o">==</span> <span class="nx">IPCMessage</span><span class="p">.</span><span class="na">TYPE_REQUEST</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">let</span> <span class="na">m</span><span class="o">:</span> <span class="nx">IPCRequest</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">IPCRequest</span><span class="o">&gt;</span> <span class="nx">msg</span><span class="p">;</span>
                <span class="nx">console</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="s">'Master received request'</span><span class="p">);</span>

                <span class="k">switch</span> <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="na">target</span><span class="p">){</span>
                    <span class="nx">case</span> <span class="nx">MessageTarget</span><span class="p">.</span><span class="na">DATA_BROKER</span><span class="o">:</span>
                        <span class="k">this</span><span class="p">.</span><span class="na">dataBroker</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="nx">case</span> <span class="nx">MessageTarget</span><span class="p">.</span><span class="na">INTERVAL_WORKER</span><span class="o">:</span>
                        <span class="k">this</span><span class="p">.</span><span class="na">intervalWorker</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="nx">case</span> <span class="nx">MessageTarget</span><span class="p">.</span><span class="na">HTTP_WORKER</span><span class="o">:</span>
                        <span class="nx">let</span> <span class="na">index</span><span class="o">:</span> <span class="nx">number</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="na">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="na">random</span><span class="p">()</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="na">httpWorkers</span><span class="p">.</span><span class="na">length</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="nx">index</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">index</span><span class="p">;</span>
                        <span class="k">this</span><span class="p">.</span><span class="na">httpWorkers</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="na">send</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="na">default</span><span class="o">:</span>
                        <span class="nx">console</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">'Cannot find message target: '</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="na">target</span><span class="p">);</span>
                <span class="p">}</span>

            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="na">type</span> <span class="o">==</span> <span class="nx">IPCMessage</span><span class="p">.</span><span class="na">TYPE_REPLY</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">let</span> <span class="na">m</span><span class="o">:</span> <span class="nx">IPCReply</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">IPCReply</span><span class="o">&gt;</span><span class="nx">msg</span><span class="p">;</span>
                <span class="nx">console</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="s">'Master received reply!'</span><span class="p">);</span>

                <span class="nx">cluster</span><span class="p">.</span><span class="na">workers</span><span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="na">originalMessage</span><span class="p">.</span><span class="na">workerId</span><span class="p">].</span><span class="na">send</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="o">/*-----------------------------------------------------------------------------</span>
         <span class="o">------------------------------------------------------------------------------</span>
         <span class="o">--</span>                          <span class="nx">SLAVE</span> <span class="nx">MESSAGE</span> <span class="nx">HANDLING</span>                          <span class="o">--</span>
         <span class="o">------------------------------------------------------------------------------</span>
         <span class="o">----------------------------------------------------------------------------*/</span>

        <span class="o">/**</span>
         <span class="o">*</span> <span class="nx">Handler</span> <span class="nx">function</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">messages</span> <span class="nx">sent</span> <span class="k">by</span> <span class="nx">the</span> <span class="nx">Master</span> <span class="nx">NodeJS</span> <span class="nx">process</span><span class="p">.</span>
         <span class="o">*</span> <span class="nx">This</span> <span class="nx">handler</span> <span class="nx">makes</span> <span class="nx">a</span> <span class="nx">distinction</span> <span class="nx">between</span> <span class="nx">messages</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">types</span> <span class="nx">IPCRequest</span> <span class="o">and</span> <span class="nx">IPCReply</span><span class="p">.</span>
         <span class="o">*</span>
         <span class="o">*</span> <span class="vi">@</span><span class="na">param</span> <span class="nx">msg</span> <span class="nx">The</span> <span class="nx">IPCMessage</span> <span class="nx">as</span> <span class="nx">passed</span> <span class="no">on</span> <span class="k">by</span> <span class="nx">the</span> <span class="nx">master</span> <span class="nx">process</span><span class="p">.</span>
         <span class="o">*/</span>
        <span class="nx">public</span> <span class="nx">onMessageFromMasterReceived</span> <span class="o">=</span> <span class="p">(</span><span class="na">msg</span><span class="o">:</span> <span class="nx">IPCMessage</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="na">type</span> <span class="o">==</span> <span class="nx">IPCMessage</span><span class="p">.</span><span class="na">TYPE_REQUEST</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">let</span> <span class="na">m</span><span class="o">:</span> <span class="nx">IPCRequest</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">IPCRequest</span><span class="o">&gt;</span><span class="nx">msg</span><span class="p">;</span>

                <span class="nx">console</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="s">'[id:'</span> <span class="o">+</span> <span class="nx">cluster</span><span class="p">.</span><span class="na">worker</span><span class="p">.</span><span class="na">id</span>  <span class="o">+</span> <span class="s">'] Received request from master: routing to: '</span> <span class="o">+</span> <span class="nx">MessageTarget</span><span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="na">target</span><span class="p">]</span> <span class="o">+</span> <span class="s">'.'</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="na">targetFunction</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="na">emitter</span><span class="p">.</span><span class="na">emit</span><span class="p">(</span><span class="nx">MessageTarget</span><span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="na">target</span><span class="p">]</span> <span class="o">+</span> <span class="s">''</span><span class="p">,</span> <span class="nx">m</span><span class="p">);</span>

            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="na">type</span> <span class="o">==</span> <span class="nx">IPCMessage</span><span class="p">.</span><span class="na">TYPE_REPLY</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">let</span> <span class="na">m</span><span class="o">:</span> <span class="nx">IPCReply</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">IPCReply</span><span class="o">&gt;</span><span class="nx">msg</span><span class="p">;</span>
                <span class="nx">console</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="s">'Slave received reply!'</span><span class="p">);</span>

                <span class="nx">MessageManager</span><span class="p">.</span><span class="na">getInstance</span><span class="p">().</span><span class="na">executeCallbackForId</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="na">originalMessage</span><span class="p">.</span><span class="na">callbackId</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>

    </code></pre></figure>

<p>Every worker has an instance of the <code class="highlighter-rouge">MessageHandler</code>, it in its turn has an event emitter on which events from the messages are broadcast.
The actual worker implementations register themselves on the emitter to receive said events.
In a future version the message handling should be split up, because now a single file (with an instance on each Node instance) handles both master and slave messages.</p>

<h3 id="final-words">Final words</h3>
<p>In conclusion; It is perfectly possible to make a more complex application for NodeJS with TypeScript.
By using TypeScript you gain compile time type checking and a more robust and better readable codebase.
Fewer errors and strange bugs are encountered because TypeScript ‘forces’ you to write better code.
<br /><br />
The Node Simple Server application was a great way to learn the ‘new’ TypeScript language.
The project is not finished, as some parts could use some more work, but it should stand as a solid starting point.
Feel free to fork the codebase, submit issues or start some discussion.</p>

        </div>
    </div>
    <div class="share-page" >
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://ordina-jworks.github.io/iot/2017/01/21/Node-with-TypeScript.html&title=Node with TypeScript&source=https://ordina-jworks.github.io" rel="nofollow" target="_blank" title="Share on LinkedIN">
            <img src="/img/social-media/LinkedIn.png"
                 alt="Share on LinkedIn" />
        </a>
        <a href="https://twitter.com/intent/tweet?text=Node with TypeScript&url=https://ordina-jworks.github.io/iot/2017/01/21/Node-with-TypeScript.html&via=lifeatordinabe&related=lifeatordinabe" rel="nofollow" target="_blank" title="Share on Twitter">
            <img src="/img/social-media/Twitter.png"
                 alt="Share on Twitter" />
        </a>
        <a href="https://facebook.com/sharer.php?u=https://ordina-jworks.github.io/iot/2017/01/21/Node-with-TypeScript.html" rel="nofollow" target="_blank" title="Share on Facebook">
            <img src="/img/social-media/Facebook.png"
                 alt="Share on Facebook" />
        </a>
    </div>
</section>


<section id="two" class="wrapper alt spotlight style2">
    
    <div class="inner">
        <a href="/author/kevin-van-den-abeele/" class="image spotlight-image">
            <img src="/img/author/kevin-van-den-abeele.jpg"
                 alt="" class="p-image"/>
        </a>

        <div class="content">
            
            <p><p>Kevin is a Principial Java consultant at Ordina, passionate about all Java and JavaScript related technologies. In his roll as Competence Leader Internet of Things he uses his knowledge of building custom software to build innovative solutions using new technologies. Currently focussing on the internet of things and sensor networks using LoRa. Loves to tinker with gadgets.</p>
</p>
            
        </div>
    </div>
    
</section>



<section id="three" class="wrapper spotlight style3">
    <div class="inner">
        <div class="content">
            <div id="disqus_thread"></div>

            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
                powered by Disqus.</a></noscript>
        </div>
    </div>
</section>

        </div>
    </section>
</div>

<div id="over"></div>

<footer>
    <div class="contact">
        <div class="address">
            <div class="icon"><i class="fa fa-fw fa-home"></i></div>
            <div class="text">Ordina Belgium<br/>Blarenberglaan 3B,<br/>2800 Mechelen, Belgium</div>
        </div>
        <div class="phone">
            <div class="icon"><i class="fa fa-fw fa-phone"></i></div>
            <div class="text"><a href="tel:003215295858">+32 15 29 58 58</a></div>
        </div>
        <div class="email">
            <div class="icon"><i class="fa fa-fw fa-envelope-o"></i></div>
            <div class="text"><a href="mailto:jworks@ordina.be">jworks@ordina.be</a></div>
        </div>
    </div>
    <ul class="social">
        <li>
            <a href="https://twitter.com/lifeatordinabe" target="_blank">
                <i class="fa fa-fw fa-twitter"></i><span>Twitter</span>
            </a>
        </li>
        <li>
            <a href="https://www.facebook.com/lifeatordinabe" target="_blank">
                <i class=" fa fa-fw fa-facebook"></i><span>Facebook</span>
            </a>
        </li>
        <li>
            <a href="https://www.linkedin.com/company/ordina-belgium" target="_blank">
                <i class=" fa fa-fw fa-linkedin"></i><span>LinkedIn</span>
            </a>
        </li>
        <li>
            <a href="https://plus.google.com/113222464071666722451" target="_blank">
                <i class=" fa fa-fw fa-google-plus"></i><span>Google+</span>
            </a>
        </li>
        <li>
            <a href="/youtube" target="_blank">
                <i class=" fa fa-fw fa-youtube"></i><span>YouTube</span>
            </a>
        </li>
        <li>
            <a href="/github" target="_blank">
                <i class=" fa fa-fw fa-github"></i><span>GitHub</span>
            </a>
        </li>
        <li>
            <a href="/feed.xml" target="_blank">
                <i class=" fa fa-fw fa-rss"></i><span>RSS Feed</span>
            </a>
        </li>
    </ul>
    <div class="copyright">
        &copy; 2017 Ordina JWorks. All rights reserved.
        <br /> Disclaimer: Opinions expressed on this blog reflect the writer's views and not the position of Ordina
        <img id="analyticsImg" src="" width="1" height="1" style="border: 0px"/>
    </div>
</footer>
<!-- Scripts -->
<script src="/js/jquery.min.js"></script>
<script src="/js/jquery.scrollex.min.js"></script>
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/skel.min.js"></script>
<script src="/js/jquery.pin.min.js"></script>
<script src="/js/util.js"></script>
<!--[if lte IE 8]>
<script src="/js/ie/respond.min.js"></script><![endif]-->


<script>
    var imageHref = "/img/node-with-typescript/node-ts.jpg";
    $(function () {
        $('body').addClass('toggle');
    });
</script>


<script src="/js/main.js"></script>

<!-- Disqus -->

<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = "https://ordina-jworks.github.io/iot/2017/01/21/Node-with-TypeScript.html";
        this.page.identifier = "/iot/2017/01/21/Node-with-TypeScript.html";
        this.page.title = "Node with TypeScript";
    };
</script>
<script src="//ordina-jworks.disqus.com/embed.js" async></script>


<!-- Google Analytics -->
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o);
        m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m);
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-70040502-1', 'auto');
    ga('send', 'pageview');
</script>
<script type="text/javascript">
    window.addEventListener('load', function () {
        if (window.ga && ga.create) {
            console.log('GA loaded correctly');
        } else {
            console.log('GA is blocked or failed to load - tracking manually...')
            document.getElementById('analyticsImg').src = 'https://jworks-techblog-analytics.cfapps.io/collect?title=' + document.title;
        }
    }, false);
</script>

<!-- Vertical timeline -->
<script src="/js/vertical-timeline/modernizr.js"></script>
<script src="/js/vertical-timeline/main.js"></script>


</body>
</html>
